((e,t)=>{'object'==typeof exports&&'undefined'!=typeof module?t(exports):'function'==typeof define&&define.amd?define(['exports'],t):t((e='undefined'!=typeof globalThis?globalThis:e||self).effector={})})(this,(e=>{function t(e,t){for(let r in e)t(e[r],r)}function r(e,t){e.forEach(t)}function a(e,t){if(!e)throw Error(t)}function n(e,t){let r=D(e).meta||{};ue={id:D(e).id,parent:ue,value:e,template:r.template||pe(),sidRoot:r.sidRoot||ue&&ue.sidRoot,meta:r};try{return t()}finally{ce('region'),ue=L(ue)}}function i({node:e=[],from:t,source:a,parent:n=t||a,to:i,target:o,child:l=i||o,scope:s={},meta:d={},family:f={type:'regular'},regional:u}={}){let c=he(n),p=he(f.links),m=he(f.owners),g=[];r(e,(e=>e&&ae(g,e)));let h={id:de(),seq:g,next:he(l),meta:d,scope:s,family:{type:f.type||A,links:p,owners:m}};return r(p,(e=>ae(E(e),h))),r(m,(e=>ae(_(e),h))),r(c,(e=>ae(e.next,h))),u&&ue&&ge(T(ue),[h]),h}function o(e,t,a){let n,i=Ye,o=null,l=Je;if(e.target&&(t=e.params,a=e.defer,n=e.meta,i='page'in e?e.page:i,e.stack&&(o=e.stack),l=W(e)||l,e=e.target),l&&Je&&l!==Je&&(Je=null),Array.isArray(e))for(let r=0;r<e.length;r++)Ge('pure',i,D(e[r]),o,t[r],l,n);else Ge('pure',i,D(e),o,t,l,n);if(a&&!Ke)return;let s,d,f,u,c,p,m={isRoot:Ke,currentPage:Ye,scope:Je,isWatch:Qe,isPure:Xe};Ke=0;e:for(;u=We();){let{idx:e,stack:t,type:a}=u;f=t.node,Ye=c=t.page,Je=W(t),c?p=c.reg:Je&&(p=Je.reg);let n=!!c,i=!!Je,o={fail:0,scope:f.scope};s=d=0;for(let r=e;r<f.seq.length&&!s;r++){let l=f.seq[r];if(l.order){let{priority:n,barrierID:i}=l.order,o=i?c?`${c.fullID}_${i}`:i:0;if(r!==e||a!==n){i?Ve.has(o)||(Ve.add(o),He(r,t,n,i)):He(r,t,n);continue e}i&&Ve.delete(o)}switch(l.type){case'mov':{let e,r=l.data;switch(r.from){case I:e=T(t);break;case R:case'b':e=t[r.from];break;case q:e=r.store;break;case M:if(p&&!p[r.store.id])if(n){let e=tt(c,r.store.id);t.page=c=e,e?p=e.reg:i?(ot(Je,r.store,0,1,r.softRead),p=Je.reg):p=void 0}else i&&ot(Je,r.store,0,1,r.softRead);e=Ee(p&&p[r.store.id]||r.store)}switch(r.to){case I:t.value=e;break;case R:case'b':t[r.to]=e;break;case M:at(c,Je,f,r.target).current=e}break}case'compute':let e=l.data;if(e.fn){Qe='watch'===G(f,'op'),Xe=e.pure;let r=e.safe?(0,e.fn)(T(t),o.scope,t):lt(o,e.fn,t);e.filter?d=!r:t.value=r,Qe=m.isWatch,Xe=m.isPure}}s=o.fail||d}if(rt&&rt(t,o),!s){let e=T(t),a=W(t);if(r(f.next,(r=>{Ge('child',c,r,t,e,a)})),a){G(f,'needFxCounter')&&Ge('child',c,a.fxCount,t,e,a),G(f,'storeChange')&&Ge('child',c,a.storeChange,t,e,a),G(f,'warnSerialize')&&Ge('child',c,a.warnSerializeNode,t,e,a);let n=a.additionalLinks[f.id];n&&r(n,(r=>{Ge('child',c,r,t,e,a)}))}}}Ke=m.isRoot,Ye=m.currentPage,Je=W(m)}function l(e,r="combine"){let a=r+'(',n='',i=0;return t(e,(e=>{i<25&&(null!=e&&(a+=n,a+=V(e)?U(e).fullName:e.toString()),i+=1,n=', ')})),a+')'}function s(e,t){let r,a,n=e;if(t){let n=U(t);0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)}else r=0===e.length?[]:[e],a=e;return{shortName:n,fullName:a,path:r}}function d(e,t){let r=t?e:e[0];ke(r);let a=r.or,n=r.and;if(n){let r=t?n:n[0];if(ye(r)&&'and'in r){let r=d(n,t);e=r[0],a={...a,...r[1]}}else e=n}return[e,a]}function f(e,...t){let r=pe();if(r){let a=r.handlers[e];if(a)return a(r,...t)}}function u(e,t){let r=st({or:t,and:'string'==typeof e?{name:e}:e}),a=(e,...t)=>(ne(!G(a,'derived'),'call of derived event','createEvent'),ne(!Xe,'unit call from pure function','operators like sample'),Ye?((e,t,r,a)=>{let n=Ye,i=null;if(t)for(i=Ye;i&&i.template!==t;)i=L(i);et(i);let o=e.create(r,a);return et(n),o})(a,n,e,t):a.create(e,t)),n=pe(),l=Object.assign(a,{graphite:i({meta:yt(r.actualOp||x,a,r),regional:1}),create:e=>(o({target:a,params:e,scope:Je}),e),watch:e=>gt(a,e),map:e=>bt(a,O,e,[Fe()]),filter:e=>bt(a,"filter",e.fn?e:e.fn,[Fe($e,1)]),filterMap:e=>bt(a,'filterMap',e,[Fe(),Ne((e=>!ve(e)),1)]),prepend(e){let t=u('* \u2192 '+a.shortName,{parent:L(a)});return f('eventPrepend',D(t)),mt(t,a,[Fe()],'prepend',e),ht(a,t),t}});return null!=r&&r.domain&&r.domain.hooks.event(l),H(l,'id',l.graphite.id),ce(l.graphite),l}function c(e,t,n,i){return Se(n,t,'first argument'),a(be(i),'second argument should be a function'),ne(!G(e,'derived'),`${t} in derived store`,`${t} in store created via createStore`),r(Array.isArray(n)?n:[n],(t=>{e.off(t),B(e).set(t,pt(vt(t,e,'on',je,i)))})),e}function p(e,t){let n=st(t),l=De(e),s=u({named:'updates',derived:1});f('storeBase',l);let d=l.id,m={subscribers:new Map,updates:s,defaultState:e,stateRef:l,getState(){let e,t=l;if(Ye){let t=Ye;for(;t&&!t.reg[d];)t=L(t);t&&(e=t)}return!e&&Je&&(ot(Je,l,1),e=Je),e&&(t=e.reg[d]),Ee(t)},setState:e=>o({target:m,params:e,defer:1,scope:Je}),reset:(...e)=>(r(e,(e=>c(m,'.reset',e,(()=>m.defaultState)))),m),on:(e,t)=>c(m,'.on',e,t),off(e){let t=B(m).get(e);return t&&(t(),B(m).delete(e)),m},map(e,t){let r,a;ye(e)&&(r=e,e=e.fn),ne(ve(t),'second argument of store.map','updateFilter');let n=m.getState();pe()?a=null:ve(n)||(a=e(n,t));let i=p(a,{name:`${m.shortName} \u2192 *`,derived:1,and:r}),o=vt(m,i,O,xe,e);return _e(P(i),{type:O,fn:e,from:l}),P(i).noInit=1,f('storeMap',l,o),i},watch(e,t){if(!t||!V(e)){let t=gt(m,e);return f('storeWatch',l,e)||e(m.getState()),t}return a(be(t),'second argument should be a function'),e.watch((e=>t(m.getState(),e)))}},g=yt(M,m,n),h=m.defaultConfig.updateFilter;m.graphite=i({scope:{state:l,fn:h},node:[Ne(((e,t,r)=>(r.scope&&!r.scope.reg[l.id]&&(r.b=1),e))),qe(l),Ne(((e,t,{a:r,b:a})=>!ve(e)&&(e!==r||a)),1),h&&Fe(xe,1),Ae({from:I,target:l})],child:s,meta:{...g,defaultState:e},regional:1}),H(m,'id',m.graphite.id),H(m,'rootStateRefId',d);let y=G(m,'serialize'),b=G(m,'derived'),v='ignore'===y,k=G(m,'sid');return k&&(H(m,'storeChange',1),l.sid=k),k||v||b||H(m,'warnSerialize',1),a(b||!ve(e),"current state can't be undefined, use null instead"),ge(m,[s]),null!=n&&n.domain&&n.domain.hooks.store(m),b||(m.reinit=u({named:'reinit'}),m.reset(m.reinit)),l.meta=m.graphite.meta,ce(m.graphite),m}function m(...e){let t,r,n;[e,n]=d(e);let i,o,l,s=e[e.length-1];if(be(s)?(r=e.slice(0,-1),t=s):r=e,1===r.length){let e=r[0];K(e)||(i=e,o=1)}if(!o&&(i=r,t)){l=1;let e=t;t=t=>e(...t)}return a(ye(i),'shape should be an object'),kt(Array.isArray(i),!l,i,n,t)}function g(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function h(e,t={}){let r=st(be(e)?{handler:e}:e,t),n=u(be(e)?{handler:e}:e,{...t,actualOp:j}),l=D(n);H(l,'op',n.kind=j),n.use=e=>(a(be(e),'.use argument should be a function'),h.scope.handler=e,n),n.use.getCurrent=()=>h.scope.handler;let s=n.finally=u({named:'finally',derived:1}),d=n.done=s.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),f=n.fail=s.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),c=n.doneData=d.map({named:'doneData',fn:({result:e})=>e}),m=n.failData=f.map({named:'failData',fn:({error:e})=>e}),h=i({scope:{handler:n.defaultConfig.handler||(()=>a(0,`no handler used in ${n.getType()}`))},node:[Ne(((e,t,r)=>{let a=t.handler,i=W(r);if(i){let e=n.sid?i.handlers.sidMap[n.sid]:i.handlers.unitMap.get(n);e&&(a=e)}return e.handler=a,e}),0,1),Ne((({params:e,req:t,handler:r,args:a=[e]},n,i)=>{let o=St(i),l=Mt(e,t,1,s,i,o),d=Mt(e,t,0,s,i,o),[f,u]=wt(r,d,a);f&&(ye(u)&&be(u.then)?u.then(l,d):l(u))}),0,1)],meta:{op:'fx',fx:'runner'}});l.scope.runner=h,ae(l.seq,Ne(((e,{runner:t},r)=>{let a=L(r)?{params:e,req:{rs(e){},rj(e){}}}:e;return r.meta||(r.meta={fxID:fe()}),o({target:t,params:a,defer:1,scope:W(r),meta:r.meta}),a.params}),0,1)),n.create=e=>{let t=g(),r={params:e,req:t};if(Je&&!Qe){let e=Je;t.req.finally((()=>{Ze(e)})).catch((()=>{}))}return o({target:n,params:r,scope:Je}),t.req};let y=n.inFlight=p(0,{serialize:'ignore',named:(G(n,'name')||n.graphite.id)+'.inFlight'}).on(n,(e=>e+1)).on(s,(e=>e-1)).map({fn:e=>e,named:'inFlight'});H(s,'needFxCounter','dec'),H(n,'needFxCounter',1);let b=n.pending=y.map({fn:e=>e>0,named:'pending'});return ge(n,[s,d,f,c,m,b,y]),null!=r&&r.domain&&r.domain.hooks.effect(n),n}function y(e,t){Se(e,'merge','first argument');let r=u({name:l(e,'merge'),derived:1,and:t});return mt(e,r,[],'merge'),r}function b(e,t){let n=0;return r(jt,(r=>{r in e&&(a(null!=e[r],$t(t,r)),n=1)})),n}function v(e,t,a){let n=[];(function e(i){te(n,i)||(ae(n,i),G(i,'op')===M&&(a||G(i,'sid'))&&t(i,G(i,'sid')),r(i.next,e),r(E(i),e),r(_(i),e))})(e)}function k(e,t){let n=Array.isArray(e)?new Map(e):e,i=new Map;if(n instanceof Map){let e={};return r(n,((r,n)=>{a(V(n),'Map key should be a unit'),t&&t(n,r),n.sid?(a(!(n.sid in e),'duplicate sid found'),e[n.sid]=r):i.set(n,r)})),{sidMap:e,unitMap:i}}return{sidMap:n,unitMap:i}}function w(e){let t=()=>e();return t.unsubscribe=()=>e(),t}let S='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',M='store',x='event',j='effect',$='domain',z='scope',C='sampler',A='crosslink',O='map',I='stack',N='barrier',q='value',F='sample',R='a',D=e=>e.graphite||e,E=e=>e.family.owners,_=e=>e.family.links,P=e=>e.stateRef,T=e=>e.value,B=e=>e.subscribers,L=e=>e.parent,W=e=>e.scope,G=(e,t)=>D(e).meta[t],H=(e,t,r)=>D(e).meta[t]=r,U=e=>e.compositeName,V=e=>(be(e)||ye(e))&&'kind'in e;const J=e=>t=>V(t)&&t.kind===e;let K=J(M),Q=J(x),X=J(j),Y=J($),Z=J(z);var ee={__proto__:null,unit:V,store:K,event:Q,effect:X,domain:Y,scope:Z,attached:e=>X(e)&&1==G(e,'attached')};let te=(e,t)=>e.includes(t),re=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)},ae=(e,t)=>e.push(t),ne=(e,t,r)=>!e&&console.error(`${t} is deprecated${r?`, use ${r} instead`:''}`);const ie=()=>{let e=0;return()=>""+ ++e};let oe,le=ie(),se=ie(),de=ie(),fe=ie(),ue=null,ce=e=>{oe&&oe(e,ue)},pe=()=>ue&&ue.template,me=e=>(e&&ue&&ue.sidRoot&&(e=`${ue.sidRoot}|${e}`),e),ge=(e,t)=>{let a=D(e);r(t,(e=>{let t=D(e);a.family.type!==$&&(t.family.type=A),ae(E(t),a),ae(_(a),t)}))},he=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(D),ye=e=>'object'==typeof e&&null!==e,be=e=>'function'==typeof e,ve=e=>void 0===e,ke=e=>a(ye(e)||be(e),'expect first argument be an object');const we=(e,t,r,n)=>a(!(!ye(e)&&!be(e)||!('family'in e)&&!('graphite'in e)),`${t}: expect ${r} to be a unit (store, event or effect)${n}`);let Se=(e,t,a)=>{Array.isArray(e)?r(e,((e,r)=>we(e,t,`${r} item of ${a}`,''))):we(e,t,a,' or array of units')},Me=(e,t,a="target")=>r(he(t),(t=>ne(!G(t,'derived'),`${e}: derived unit in "${a}"`,"createEvent/createStore"))),xe=(e,{fn:t},{a:r})=>t(e,r),je=(e,{fn:t},{a:r})=>t(r,e),$e=(e,{fn:t})=>t(e);const ze=(e,t,r,a)=>{let n={id:se(),type:e,data:t};return r&&(n.order={priority:r},a&&(n.order.barrierID=++Ce)),n};let Ce=0,Ae=({from:e=M,store:t,target:r,to:a=(r?M:I),batch:n,priority:i})=>ze('mov',{from:e,store:t,to:a,target:r},i,n),Oe=({fn:e,batch:t,priority:r,safe:a=0,filter:n=0,pure:i=0})=>ze('compute',{fn:e,safe:a,filter:n,pure:i},r,t),Ie=({fn:e})=>Oe({fn:e,priority:j}),Ne=(e,t,r)=>Oe({fn:e,safe:1,filter:t,priority:r&&j}),qe=(e,t,r)=>Ae({store:e,to:t?I:R,priority:r&&C,batch:1}),Fe=(e=$e,t)=>Oe({fn:e,pure:1,filter:t}),Re={mov:Ae,compute:Oe,filter:({fn:e,pure:t})=>Oe({fn:e,filter:1,pure:t}),run:Ie},De=e=>({id:se(),current:e}),Ee=({current:e})=>e,_e=(e,t)=>{e.before||(e.before=[]),ae(e.before,t)},Pe=null;const Te=(e,t)=>{if(!e)return t;if(!t)return e;let r;return(e.v.type===t.v.type&&e.v.id>t.v.id||Ue(e.v.type)>Ue(t.v.type))&&(r=e,e=t,t=r),r=Te(e.r,t),e.r=e.l,e.l=r,e},Be=[];let Le=0;for(;Le<6;)ae(Be,{first:null,last:null,size:0}),Le+=1;const We=()=>{for(let e=0;e<6;e++){let t=Be[e];if(t.size>0){if(3===e||4===e){t.size-=1;let e=Pe.v;return Pe=Te(Pe.l,Pe.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Ge=(e,t,r,a,n,i,o)=>He(0,{a:null,b:null,node:r,parent:a,value:n,page:t,scope:i,meta:o},e),He=(e,t,r,a=0)=>{let n=Ue(r),i=Be[n],o={v:{idx:e,stack:t,type:r,id:a},l:null,r:null};3===n||4===n?Pe=Te(Pe,o):(0===i.size?i.first=o:i.last.r=o,i.last=o),i.size+=1},Ue=e=>{switch(e){case'child':return 0;case'pure':return 1;case'read':return 2;case N:return 3;case C:return 4;case j:return 5;default:return-1}},Ve=new Set;let Je,Ke=1,Qe=0,Xe=0,Ye=null,Ze=e=>{Je=e},et=e=>{Ye=e};const tt=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=L(e);if(e)return e}return null};let rt,at=(e,t,r,a,n)=>{let i=tt(e,a.id);return i?i.reg[a.id]:t?(ot(t,a,n),t.reg[a.id]):a};const nt=e=>e;let ot=(e,t,a,n,i)=>{var o;let l=e.reg,s=t.sid,d=null==t||null===(o=t.meta)||void 0===o?void 0:o.serialize;if(l[t.id])return;let f={id:t.id,current:t.current,meta:t.meta};if(s&&s in e.values.sidMap&&!(s in e.sidIdMap))f.current=(e.fromSerialize&&'ignore'!==d&&(null==d?void 0:d.read)||nt)(e.values.sidMap[s]);else if(f.id in e.values.idMap)f.current=e.values.idMap[f.id];else if(t.before&&!i){let i=0,o=a||!t.noInit||n;r(t.before,(t=>{switch(t.type){case O:{let r=t.from;if(r||t.fn){r&&ot(e,r,a,n);let i=r&&l[r.id].current;o&&(f.current=t.fn?t.fn(i):i)}break}case'field':i||(i=1,f.current=Array.isArray(f.current)?[...f.current]:{...f.current}),ot(e,t.from,a,n),o&&(f.current[t.field]=l[l[t.from.id].id].current)}}))}s&&(e.sidIdMap[s]=t.id),l[t.id]=f};const lt=(e,t,r)=>{try{return t(T(r),e.scope,r)}catch(t){console.error(t),e.fail=1,e.failReason=t}};let st=(e,r={})=>(ye(e)&&(st(e.or,r),t(e,((e,t)=>{ve(e)||'or'===t||'and'===t||(r[t]=e)})),st(e.and,r)),r);const dt=(e,t)=>{re(e.next,t),re(E(e),t),re(_(e),t)},ft=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=_(e);for(;a=n.pop();)dt(a,e),(t||r&&'sample'!==G(e,'op')||a.family.type===A)&&ft(a,t,'on'!==G(a,'op')&&r);for(n=E(e);a=n.pop();)dt(a,e),r&&a.family.type===A&&ft(a,t,'on'!==G(a,'op')&&r)},ut=e=>e.clear();let ct=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),K(e))ut(B(e));else if(Y(e)){r=1;let t=e.history;ut(t.events),ut(t.effects),ut(t.stores),ut(t.domains)}ft(D(e),!!t,r)},pt=e=>{let t=()=>ct(e);return t.unsubscribe=t,t},mt=(e,t,r,a,n)=>i({node:r,parent:e,child:t,scope:{fn:n},meta:{op:a},family:{owners:[e,t],links:t},regional:1}),gt=(e,t)=>(a(be(t),'.watch argument should be a function'),pt(i({scope:{fn:t},node:[Ie({fn:$e})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1}))),ht=(e,t,r=x)=>{L(e)&&L(e).hooks[r](t)},yt=(e,t,r)=>{let a=st(r),n=e===$,i=le(),{sid:o=null,named:l=null,domain:d=null,parent:f=d}=a,u=l||a.name||(n?'':i),c=s(u,f),p={op:t.kind=e,name:t.shortName=u,sid:t.sid=me(o),named:l,unitId:t.id=i,serialize:a.serialize,derived:a.derived,config:a};if(t.parent=f,t.compositeName=c,t.defaultConfig=a,t.thru=e=>(ne(0,'thru','js pipe'),e(t)),t.getType=()=>c.fullName,!n){t.subscribe=e=>(ke(e),t.watch(be(e)?e:t=>e.next&&e.next(t))),t[S]=()=>t;let e=pe();e&&(p.nativeTemplate=e)}return p};const bt=(e,t,r,a)=>{let n;ye(r)&&(n=r,r=r.fn);let i=u({name:`${e.shortName} \u2192 *`,derived:1,and:n});return mt(e,i,a,t,r),i},vt=(e,t,r,a,n)=>{let i=P(t),o=Ae({store:i,to:R,priority:'read'});r===O&&(o.data.softRead=1);let l=[o,Fe(a)];return f('storeOnMap',i,l,K(e)&&P(e)),mt(e,t,l,r,n)},kt=(e,r,n,i,o)=>{let s=e?e=>[...e]:e=>({...e}),d=e?[]:{},u=s(d),c=De(u),m=De(1);c.type=e?'list':'shape',c.noInit=1,f('combineBase',c,m);let g=p(u,{name:l(n),derived:1,and:i}),h=P(g);h.noInit=1,H(g,'isCombine',1);let y=qe(c);y.order={priority:'barrier'};let b=[Ne(((e,t,r)=>(r.scope&&!r.scope.reg[c.id]&&(r.c=1),e))),y,Ae({store:m,to:'b'}),Ne(((e,{key:t},a)=>{if(a.c||e!==a.a[t])return r&&a.b&&(a.a=s(a.a)),a.a[t]=e,1}),1),Ae({from:R,target:c}),Ae({from:q,store:0,target:m}),Ae({from:q,store:1,target:m,priority:N,batch:1}),qe(c,1),o&&Fe()];return t(n,((e,t)=>{if(!K(e))return a(!V(e)&&!ve(e),`combine expects a store in a field ${t}`),void(u[t]=d[t]=e);d[t]=e.defaultState,u[t]=e.getState();let r=mt(e,g,b,'combine',o);r.scope.key=t;let n=P(e);_e(c,{type:'field',field:t,from:n}),f('combineField',n,r)})),g.defaultShape=n,_e(h,{type:O,from:c,fn:o}),pe()||(g.defaultState=o?h.current=o(u):d),g};let wt=(e,t,r)=>{try{return[1,e(...r)]}catch(e){return t(e),[0,null]}},St=e=>{let t=W(e),r={ref:t};return t&&ae(t.activeEffects,r),r},Mt=(e,t,r,a,n,i)=>l=>{i.ref&&re(i.ref.activeEffects,i),o({target:[a,xt],params:[r?{status:'done',params:e,result:l}:{status:'fail',params:e,error:l},{value:l,fn:r?t.rs:t.rj}],defer:1,page:n.page,scope:i.ref,meta:n.meta})};const xt=i({node:[Ie({fn:({fn:e,value:t})=>e(t)})],meta:{op:'fx',fx:'sidechain'}}),jt=['source','clock','target'],$t=(e,t)=>e+`: ${t} should be defined`;let zt=(e,t,r,n,i,o,l,s,d,c,g,h)=>{let b=!!i;a(!ve(r)||!ve(t),$t(e,'either source or clock'));let v=0;ve(r)?v=1:V(r)||(r=m(r)),ve(t)?t=r:(Se(t,e,'clock'),Array.isArray(t)&&(t=y(t))),v&&(r=t),s||l||(l=r.shortName);let k='none';(g||n)&&(V(n)?k='unit':(a(be(n),'`filter` should be function or unit'),k='fn')),i?(Se(i,e,'target'),Me(e,i)):'none'===k&&c&&K(r)&&K(t)?i=p(o?o(Ee(P(r)),Ee(P(t))):Ee(P(r)),{name:l,sid:h,or:s}):(i=u({name:l,derived:1,or:s}),f('sampleTarget',D(i)));let w=De(),S=[];if('unit'===k){let[r,a]=At(n,i,t,w,e);S=[...Ct(a),...Ct(r)]}let[M,x]=At(r,i,t,w,e),j=mt(t,i,[f('sampleSourceLoader'),Ae({from:I,target:w}),...Ct(x),qe(M,1,d),...S,qe(w),'fn'===k&&Fe(((e,t,{a:r})=>n(e,r)),1),o&&Fe(xe),f('sampleSourceUpward',b)],e,o);return ge(r,[j]),Object.assign(j.meta,s,{joint:1}),i};const Ct=e=>[qe(e),Ne(((e,t,{a:r})=>r),1)],At=(e,t,r,a,n)=>{let o=K(e),l=o?P(e):De(),s=De(o);return o||i({parent:e,node:[Ae({from:I,target:l}),Ae({from:q,store:1,target:s})],family:{owners:[e,t,r],links:t},meta:{op:n},regional:1}),f('sampleSource',s,l,a),[l,s]},Ot=(e,t,r,a)=>{let n=e[t];n&&o({target:n,params:Array.isArray(n)?n.map((()=>r)):r,defer:1,stack:a})},It=e=>e;e.allSettled=(e,{scope:t,params:r}={})=>{if(!V(e))return Promise.reject(new Error('first argument should be unit'));if(!(X(e)||Q(e)||K(e)||Z(e)))return Promise.reject(new Error('first argument accepts only effects, events, stores or scopes'));Z(e)&&(t=e);let a=g();a.parentFork=Je;let{fxCount:n}=t;ae(n.scope.defers,a);let i=[],l=[];return Z(e)||(ae(i,e),ae(l,X(e)?{params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}:r)),ae(i,n),ae(l,null),o({target:i,params:l,scope:t}),a.req},e.attach=e=>{let t;[e,t]=d(e,1);let{source:r,effect:a,mapParams:n}=e,i=h(e,t);H(i,'attached',1);let l,{runner:f}=D(i).scope,u=Ne(((e,t,a)=>{let l,{params:s,req:d,handler:f}=e,u=i.finally,c=St(a),p=Mt(s,d,0,u,a,c),m=a.a,g=X(f),h=1;if(n?[h,l]=wt(n,p,[s,m]):l=r&&g?m:s,h){if(!g)return e.args=[m,l],1;o({target:f,params:{params:l,req:{rs:Mt(s,d,1,u,a,c),rj:p}},page:a.page,defer:1,meta:a.meta})}}),1,1);if(r){let e;K(r)?(e=r,ge(e,[i])):(e=m(r),ge(i,[e])),l=[qe(P(e)),u]}else l=[u];f.seq.splice(1,0,...l),i.use(a);let c=L(a);return c&&(Object.assign(U(i),s(i.shortName,c)),i.defaultConfig.parent=c),ht(a,i,j),i},e.clearNode=ct,e.combine=m,e.createApi=(...e)=>{let[[r,a],n]=d(e),i={};return t(a,((e,t)=>{let a=i[t]=u(t,{parent:L(r),config:n});r.on(a,e),ht(r,a)})),i},e.createDomain=function e(a,n){let l=st({or:n,and:'string'==typeof a?{name:a}:a}),s=i({family:{type:$},regional:1,parent:(null==l?void 0:l.domain)||(null==l?void 0:l.parent)}),d={history:{},graphite:s,hooks:{}};s.meta=yt($,d,{parent:(null==l?void 0:l.domain)||(null==l?void 0:l.parent),or:l}),t({Event:u,Effect:h,Store:p,Domain:e},((e,t)=>{let a=t.toLowerCase(),n=(e=>u({named:e}))(`on${t}`);d.hooks[a]=n;let i=new Set;d.history[`${a}s`]=i,n.create=e=>(o(n,e),e),ae(D(n).seq,Ne(((e,t,r)=>(r.scope=null,e)))),n.watch((e=>{ge(d,[e]),i.add(e),e.ownerSet||(e.ownerSet=i),L(e)||(e.parent=d)})),ge(d,[n]),d[`onCreate${t}`]=e=>(r(i,e),n.watch(e)),d[`create${t}`]=d[a]=(t,r)=>{let a=st({and:r,or:t});return null!=a&&a.domain?e(t,r):n(e(t,{parent:d,or:a}))}}));let f=L(d);return f&&t(d.hooks,((e,t)=>mt(e,f.hooks[t]))),null!=l&&l.domain&&l.domain.hooks.domain(d),d},e.createEffect=h,e.createEvent=u,e.createNode=i,e.createStore=p,e.createStoreObject=(...e)=>(ne(0,'createStoreObject','combine'),m(...e)),e.createWatch=({unit:e,fn:t,scope:r})=>{let a=[Re.run({fn:e=>t(e)})];if(r){let t=i({node:a}),n=e.graphite.id,o=r.additionalLinks,l=o[n]||[];return o[n]=l,l.push(t),w((()=>{let e=l.indexOf(t);-1!==e&&l.splice(e,1),ct(t)}))}{let t=i({node:a,parent:[e],family:{owners:e}});return w((()=>{ct(t)}))}},e.fork=(e,t)=>{let n,o=e;Y(e)&&(n=e,o=t);let l=(e=>{let t=i({scope:{defers:[],inFlight:0,fxID:0},node:[Ne(((e,t,r)=>{L(r)?'dec'===G(L(r).node,'needFxCounter')?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1})),Oe({priority:C,batch:1}),Ne(((e,t)=>{let{defers:a,fxID:n}=t;t.inFlight>0||0===a.length||Promise.resolve().then((()=>{t.fxID===n&&r(a.splice(0,a.length),(e=>{Ze(e.parentFork),e.rs(e.value)}))}))}),0,1)]}),a=i({node:[Ne(((e,t,r)=>{let a=L(r);if(a){let t=a.node;if(!G(t,'isCombine')||L(a)&&'combine'!==G(L(a).node,'op')){let a=W(r),n=t.scope.state.id,i=G(t,'sid');a.sidIdMap[i]=n,a.values.sidMap[i]=e;let o=G(t,'serialize');o&&a.sidSerializeSettings.set(i,'ignore'===o?{ignore:1}:{ignore:0,write:o.write})}}}))]}),n=i({node:[Ne(((e,t,r)=>{let a=W(r);if(a){let e=L(r);e&&(!G(e.node,'isCombine')||L(e)&&'combine'!==G(L(e).node,'op'))&&(a.warnSerialize=1)}}))]}),o={cloneOf:e,reg:{},values:{sidMap:{},idMap:{}},sidIdMap:{},sidSerializeSettings:new Map,getState(e){if('current'in e)return at(Ye,o,null,e).current;let t=D(e);return at(Ye,o,t,t.scope.state,1).current},kind:z,graphite:i({family:{type:$,links:[t,a,n]},meta:{unit:'fork'},scope:{forkInFlightCounter:t}}),additionalLinks:{},handlers:{sidMap:{},unitMap:new Map},fxCount:t,storeChange:a,warnSerializeNode:n,activeEffects:[]};return o})(n);if(o){let e=o.scope;if(e){let t=e.activeEffects;e.activeEffects=[],l.activeEffects=t,r(t,(e=>e.ref=l))}if(o.values){let{sidMap:e,unitMap:t}=k(o.values,(e=>a(K(e),'Values map can contain only stores as keys')));Object.assign(l.values.sidMap,e),r(t,((e,t)=>{l.values.idMap[t.stateRef.id]=e})),l.fromSerialize=!(Array.isArray(o.values)||o.values instanceof Map)}o.handlers&&(l.handlers=k(o.handlers,(e=>a(X(e),"Handlers map can contain only effects as keys"))))}return l},e.forward=e=>{let t='forward',[{from:r,to:a},n]=d(e,1);return Se(r,t,'"from"'),Se(a,t,'"to"'),Me(t,a,'to'),pt(i({parent:r,child:a,meta:{op:t,config:n},family:{},regional:1}))},e.fromObservable=e=>{ke(e);let t=S in e?e[S]():e;a(t.subscribe,'expect observable to have .subscribe');let r=u(),n=pt(r);return t.subscribe({next:r,error:n,complete:n}),r},e.guard=(...e)=>{let[[t,r],a]=d(e);return r||(r=t,t=r.source),b(r,'guard'),zt('guard',r.clock,t,r.filter,r.target,null,r.name,a,!r.greedy,0,1)},e.hydrate=(e,{values:t})=>{a(ye(t),'values property should be an object');let{sidMap:n,unitMap:i}=k(t),l=Object.getOwnPropertyNames(n),s={};r(i,((e,t)=>{s[t.stateRef.id]=t}));let d,f,u,c=[],p=[];Z(e)?(d=e,u=1,a(d.cloneOf,'scope should be created from domain'),f=D(d.cloneOf)):Y(e)?f=D(e):a(0,'first argument of hydrate should be domain or scope'),v(f,((e,t)=>{if(t&&te(l,t)){ae(c,e);let r=G(e,'serialize');r&&'ignore'!==r&&(n[t]=r.read(n[t])),ae(p,n[t])}else e.scope.state.id in s&&(ae(c,e),ae(p,i.get(s[e.scope.state.id])))}),1),o({target:c,params:p,scope:d}),u&&Object.assign(d.values.sidMap,n)},e.is=ee,e.launch=o,e.merge=y,e.restore=(e,r,a)=>{if(K(e))return ne(0,'restore($store)'),e;if(Q(e)||X(e)){let t=L(e),n=p(r,{parent:t,name:e.shortName,and:a});return mt(X(e)?e.doneData:e,n),t&&t.hooks.store(n),n}let n=Array.isArray(e)?[]:{};return t(e,((e,t)=>n[t]=K(e)?e:p(e,{name:t}))),n},e.sample=(...e)=>{let t,r,a,n,[[i,o,l],s]=d(e),f=1;return ve(o)&&ye(i)&&b(i,F)&&(o=i.clock,l=i.fn,f=!i.greedy,n=i.filter,t=i.target,r=i.name,a=i.sid,i=i.source),zt(F,o,i,n,t,l,r,s,f,1,0,a)},e.scopeBind=(e,{scope:t,safe:r}={})=>{a(t||Je||r,'scopeBind cannot be called outside of forked .watch');let n=t||Je;return X(e)?t=>{let r=g();return o({target:e,params:{params:t,req:r},scope:n}),r.req}:t=>(o({target:e,params:t,scope:n}),t)},e.serialize=(e,r={})=>{e.warnSerialize&&console.error('There is a store without sid in this scope, its value is omitted');let n=r.ignore?r.ignore.map((({sid:e})=>e)):[],i={};return t(e.values.sidMap,((t,r)=>{var a;if(te(n,r))return;let o=e.sidIdMap[r],l=null!==(a=e.sidSerializeSettings.get(r))&&void 0!==a?a:{ignore:0,write:It};l.ignore||(i[r]=(0,l.write)(o&&o in e.reg?e.reg[o].current:t))})),'onlyChanges'in r&&!r.onlyChanges&&(a(e.cloneOf,'scope should be created from domain'),v(D(e.cloneOf),((t,r)=>{r in i||te(n,r)||G(t,'isCombine')||'ignore'===G(t,'serialize')||(i[r]=e.getState(t))}))),i},e.setGraphInspector=e=>{oe=e},e.setInspector=e=>{rt=e},e.setStoreName=(e,t)=>{e.shortName=t,Object.assign(U(e),s(t,L(e)))},e.split=(...e)=>{let r,n,o='split',[[l,s],c]=d(e),p=!s;p&&(r=l.cases,s=l.match,n=l.clock,l=l.source);let m=K(s),g=!V(s)&&be(s),h=!m&&!g&&ye(s);a(V(l),'source must be a unit'),r||(r={}),p?t(r,((e,t)=>Me(o,e,`cases.${t}`))):(a(h,'match should be an object'),t(s,((e,t)=>r[t]=u({derived:1,named:`cases.${t}`,and:c}))),r.__=u({derived:1,named:'cases.__',and:c}));let y,b=new Set([].concat(l,n||[],Object.values(r))),v=Object.keys(m||g?r:s);if(m||g)m&&b.add(s),y=[m&&qe(P(s),0,1),Oe({safe:m,filter:1,pure:!m,fn(e,t,r){let a=String(m?r.a:s(e));Ot(t,te(v,a)?a:'__',e,r)}})];else if(h){let e=De({});e.type='shape';let r,a=[];t(s,((t,n)=>{if(V(t)){r=1,ae(a,n),b.add(t);let i=mt(t,[],[qe(e),Ne(((e,t,{a:r})=>r[n]=e))]);if(K(t)){e.current[n]=t.getState();let r=P(t);_e(e,{from:r,field:n,type:'field'}),f('splitMatchStore',r,i)}}})),r&&f('splitBase',e),y=[r&&qe(e,0,1),Fe(((e,t,r)=>{for(let n=0;n<v.length;n++){let i=v[n];if(te(a,i)?r.a[i]:s[i](e))return void Ot(t,i,e,r)}Ot(t,'__',e,r)}),1)]}else a(0,'expect match to be unit, function or object');let k=i({meta:{op:o},parent:n?[]:l,scope:r,node:y,family:{owners:Array.from(b)},regional:1});if(n&&zt(o,n,l,null,k,null,o,c,0,0,0),!p)return r},e.step=Re,e.version="22.8.3",e.withFactory=({sid:e,name:t,loc:r,method:a,fn:o})=>n(i({meta:{sidRoot:me(e),sid:e,name:t,loc:r,method:a,type:'factory'}}),o),e.withRegion=n,Object.defineProperty(e,'__esModule',{value:1})}));
//# sourceMappingURL=effector.umd.js.map
