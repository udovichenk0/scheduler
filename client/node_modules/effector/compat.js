'use strict';function e(e,r){for(var n in e)r(e[n],n)}function r(e,r){e.forEach(r)}function n(e,r){if(!e)throw Error(r)}function t(e,r){var n=A(e).meta||{};ee={id:A(e).id,parent:ee,value:e,template:n.template||ne(),sidRoot:n.sidRoot||ee&&ee.sidRoot,meta:n};try{return r()}finally{re('region'),ee=q(ee)}}function a(e){var n=void 0===e?{}:e,t=n.node,a=void 0===t?[]:t,i=n.parent,o=n.child,u=void 0===o?n.to||n.target:o,f=n.scope,s=void 0===f?{}:f,c=n.meta,d=void 0===c?{}:c,l=n.family,p=void 0===l?{type:'regular'}:l,v=n.regional,m=ie(void 0===i?n.from||n.source:i),g=ie(p.links),h=ie(p.owners),y=[];r(a,(function(e){return e&&$(y,e)}));var b={id:Y(),seq:y,next:ie(u),meta:d,scope:s,family:{type:p.type||"crosslink",links:g,owners:h}};return r(g,(function(e){return $(O(e),b)})),r(h,(function(e){return $(z(e),b)})),r(m,(function(e){return $(e.next,b)})),v&&ee&&ae(I(ee),[b]),b}function i(e,n,t){var a,i=We,o=null,u=qe;if(e.target&&(n=e.params,t=e.defer,a=e.meta,i='page'in e?e.page:i,e.stack&&(o=e.stack),u=F(e)||u,e=e.target),u&&qe&&u!==qe&&(qe=null),Array.isArray(e))for(var f=0;f<e.length;f++)De('pure',i,A(e[f]),o,n[f],u,a);else De('pure',i,A(e),o,n,u,a);if(!t||Le){var s,c,d,l,p,v,m={isRoot:Le,currentPage:We,scope:qe,isWatch:Be,isPure:Te};Le=0;for(var g=function(){var e=l.idx,n=l.stack,t=l.type;d=n.node,We=p=n.page,qe=F(n),p?v=p.reg:qe&&(v=qe.reg);var a=!!p,i=!!qe,o={fail:0,scope:d.scope};s=c=0;for(var u=e;u<d.seq.length&&!s;u++){var f=d.seq[u];if(f.order){var g=f.order,h=g.priority,y=g.barrierID,b=y?p?p.fullID+"_"+y:y:0;if(u!==e||t!==h)return y?Pe.has(b)||(Pe.add(b),Ee(u,n,h,y)):Ee(u,n,h),"continue|kernelLoop";y&&Pe.delete(b)}switch(f.type){case'mov':var x=f.data,w=void 0;switch(x.from){case j:w=I(n);break;case"a":case'b':w=n[x.from];break;case"value":w=x.store;break;case"store":if(v&&!v[x.store.id])if(a){var k=Ue(p,x.store.id);n.page=p=k,k?v=k.reg:i?(Je(qe,x.store,0,1,x.softRead),v=qe.reg):v=void 0}else i&&Je(qe,x.store,0,1,x.softRead);w=Ae(v&&v[x.store.id]||x.store)}switch(x.to){case j:n.value=w;break;case"a":case'b':n[x.to]=w;break;case"store":Ve(p,qe,d,x.target).current=w}break;case'compute':var S=f.data;if(S.fn){Be='watch'===R(d,'op'),Te=S.pure;var M=S.safe?(0,S.fn)(I(n),o.scope,n):Ke(o,S.fn,n);S.filter?c=!M:n.value=M,Be=m.isWatch,Te=m.isPure}}s=o.fail||c}if(Fe&&Fe(n,o),!s){var A=I(n),O=F(n);if(r(d.next,(function(e){De('child',p,e,n,A,O)})),O){R(d,'needFxCounter')&&De('child',p,O.fxCount,n,A,O),R(d,'storeChange')&&De('child',p,O.storeChange,n,A,O),R(d,'warnSerialize')&&De('child',p,O.warnSerializeNode,n,A,O);var z=O.additionalLinks[d.id];z&&r(z,(function(e){De('child',p,e,n,A,O)}))}}};l=Re();)g();Le=m.isRoot,We=m.currentPage,qe=F(m)}}function o(r,n){void 0===n&&(n='combine');var t=n+'(',a='',i=0;return e(r,(function(e){i<25&&(null!=e&&(t+=a,t+=_(e)?E(e).fullName:e.toString()),i+=1,a=', ')})),t+')'}function u(e,r){var n,t,a=e;if(r){var i=E(r);0===e.length?(n=i.path,t=i.fullName):(n=i.path.concat([e]),t=0===i.fullName.length?e:i.fullName+'/'+e)}else n=0===e.length?[]:[e],t=e;return{shortName:a,fullName:t,path:n}}function f(e,r){var n=r?e:e[0];se(n);var t=n.or,a=n.and;if(a){var i=r?a:a[0];if(oe(i)&&'and'in i){var o=f(a,r);e=o[0],t=Object.assign({},t,o[1])}else e=a}return[e,t]}function s(e){var r=ne();if(r){for(var n=r.handlers[e],t=arguments.length,a=new Array(t>1?t-1:0),i=1;i<t;i++)a[i-1]=arguments[i];if(n)return n.apply(void 0,[r].concat(a))}}function c(e,r,n,t){var a=We,i=null;if(r)for(i=We;i&&i.template!==r;)i=q(i);He(i);var o=e.create(n,t);return He(a),o}function d(e,r){var n=Qe({or:r,and:'string'==typeof e?{name:e}:e}),t=function e(r){J(!R(e,'derived'),'call of derived event','createEvent'),J(!Te,'unit call from pure function','operators like sample');for(var n=arguments.length,t=new Array(n>1?n-1:0),a=1;a<n;a++)t[a-1]=arguments[a];return We?c(e,o,r,t):e.create(r,t)},o=ne(),u=Object.assign(t,{graphite:a({meta:ir(n.actualOp||"event",t,n),regional:1}),create:function(e){return i({target:t,params:e,scope:qe}),e},watch:function(e){return tr(t,e)},map:function(e){return or(t,M,e,[Se()])},filter:function(e){return or(t,"filter",e.fn?e:e.fn,[Se(me,1)])},filterMap:function(e){return or(t,'filterMap',e,[Se(),we((function(e){return!fe(e)}),1)])},prepend:function(e){var r=d('* \u2192 '+t.shortName,{parent:q(t)});return s('eventPrepend',A(r)),nr(r,t,[Se()],'prepend',e),ar(t,r),r}});return null!=n&&n.domain&&n.domain.hooks.event(u),D(u,'id',u.graphite.id),re(u.graphite),u}function l(e,t,a,i){return de(a,t,'first argument'),n(ue(i),'second argument should be a function'),J(!R(e,'derived'),t+" in derived store",t+" in store created via createStore"),r(Array.isArray(a)?a:[a],(function(r){e.off(r),N(e).set(r,rr(ur(r,e,'on',ve,i)))})),e}function p(e,t){var o=Qe(t),u=je(e),f=d({named:'updates',derived:1});s('storeBase',u);var c=u.id,v={subscribers:new Map,updates:f,defaultState:e,stateRef:u,getState:function(){var e,r=u;if(We){for(var n=We;n&&!n.reg[c];)n=q(n);n&&(e=n)}return!e&&qe&&(Je(qe,u,1),e=qe),e&&(r=e.reg[c]),Ae(r)},setState:function(e){return i({target:v,params:e,defer:1,scope:qe})},reset:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return r(n,(function(e){return l(v,'.reset',e,(function(){return v.defaultState}))})),v},on:function(e,r){return l(v,'.on',e,r)},off:function(e){var r=N(v).get(e);return r&&(r(),N(v).delete(e)),v},map:function(e,r){var n,t;oe(e)&&(n=e,e=e.fn),J(fe(r),'second argument of store.map','updateFilter');var a=v.getState();ne()?t=null:fe(a)||(t=e(a,r));var i=p(t,{name:v.shortName+" \u2192 *",derived:1,and:n}),o=ur(v,i,M,pe,e);return Oe(C(i),{type:M,fn:e,from:u}),C(i).noInit=1,s('storeMap',u,o),i},watch:function(e,r){if(!r||!_(e)){var t=tr(v,e);return s('storeWatch',u,e)||e(v.getState()),t}return n(ue(r),'second argument should be a function'),e.watch((function(e){return r(v.getState(),e)}))}},m=ir("store",v,o),g=v.defaultConfig.updateFilter;v.graphite=a({scope:{state:u,fn:g},node:[we((function(e,r,n){return n.scope&&!n.scope.reg[u.id]&&(n.b=1),e})),ke(u),we((function(e,r,n){var t=n.a,a=n.b;return!fe(e)&&(e!==t||a)}),1),g&&Se(pe,1),ye({from:j,target:u})],child:f,meta:Object.assign({},m,{defaultState:e}),regional:1}),D(v,'id',v.graphite.id),D(v,'rootStateRefId',c);var h=R(v,'serialize'),y=R(v,'derived'),b='ignore'===h,x=R(v,'sid');return x&&(D(v,'storeChange',1),u.sid=x),x||b||y||D(v,'warnSerialize',1),n(y||!fe(e),"current state can't be undefined, use null instead"),ae(v,[f]),null!=o&&o.domain&&o.domain.hooks.store(v),y||(v.reinit=d({named:'reinit'}),v.reset(v.reinit)),u.meta=v.graphite.meta,re(v.graphite),v}function v(){for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];var a,i,o,u=f(r);o=u[1];var s,c,d,l=(r=u[0])[r.length-1];if(ue(l)?(i=r.slice(0,-1),a=l):i=r,1===i.length){var p=i[0];L(p)||(s=p,c=1)}if(!c&&(s=i,a)){d=1;var v=a;a=function(e){return v.apply(void 0,e)}}return n(oe(s),'shape should be an object'),fr(Array.isArray(s),!d,s,o,a)}function m(){var e={};return e.req=new Promise((function(r,n){e.rs=r,e.rj=n})),e.req.catch((function(){})),e}function g(e,r){void 0===r&&(r={});var t=Qe(ue(e)?{handler:e}:e,r),o=d(ue(e)?{handler:e}:e,Object.assign({},r,{actualOp:"effect"})),u=A(o);D(u,'op',o.kind="effect"),o.use=function(e){return n(ue(e),'.use argument should be a function'),g.scope.handler=e,o},o.use.getCurrent=function(){return g.scope.handler};var f=o.finally=d({named:'finally',derived:1}),s=o.done=f.filterMap({named:'done',fn:function(e){if('done'===e.status)return{params:e.params,result:e.result}}}),c=o.fail=f.filterMap({named:'fail',fn:function(e){if('fail'===e.status)return{params:e.params,error:e.error}}}),l=o.doneData=s.map({named:'doneData',fn:function(e){return e.result}}),v=o.failData=c.map({named:'failData',fn:function(e){return e.error}}),g=a({scope:{handler:o.defaultConfig.handler||function(){return n(0,"no handler used in "+o.getType())}},node:[we((function(e,r,n){var t=r.handler,a=F(n);if(a){var i=o.sid?a.handlers.sidMap[o.sid]:a.handlers.unitMap.get(o);i&&(t=i)}return e.handler=t,e}),0,1),we((function(e,r,n){var t=e.params,a=e.req,i=e.handler,o=e.args,u=void 0===o?[t]:o,s=cr(n),c=dr(t,a,1,f,n,s),d=dr(t,a,0,f,n,s),l=sr(i,d,u),p=l[1];l[0]&&(oe(p)&&ue(p.then)?p.then(c,d):c(p))}),0,1)],meta:{op:'fx',fx:'runner'}});u.scope.runner=g,$(u.seq,we((function(e,r,n){var t=r.runner,a=q(n)?{params:e,req:{rs:function(){},rj:function(){}}}:e;return n.meta||(n.meta={fxID:Z()}),i({target:t,params:a,defer:1,scope:F(n),meta:n.meta}),a.params}),0,1)),o.create=function(e){var r=m(),n={params:e,req:r};if(qe&&!Be){var t=qe;r.req.finally((function(){Ge(t)})).catch((function(){}))}return i({target:o,params:n,scope:qe}),r.req};var h=o.inFlight=p(0,{serialize:'ignore',named:(R(o,'name')||o.graphite.id)+'.inFlight'}).on(o,(function(e){return e+1})).on(f,(function(e){return e-1})).map({fn:function(e){return e},named:'inFlight'});D(f,'needFxCounter','dec'),D(o,'needFxCounter',1);var y=o.pending=h.map({fn:function(e){return e>0},named:'pending'});return ae(o,[f,s,c,l,v,y,h]),null!=t&&t.domain&&t.domain.hooks.effect(o),o}function h(e,r){de(e,'merge','first argument');var n=d({name:o(e,'merge'),derived:1,and:r});return nr(e,n,[],'merge'),n}function y(e,t){var a=0;return r(pr,(function(r){r in e&&(n(null!=e[r],vr(t,r)),a=1)})),a}function b(e,n,t){var a=[];(function e(i){U(a,i)||($(a,i),"store"===R(i,'op')&&(t||R(i,'sid'))&&n(i,R(i,'sid')),r(i.next,e),r(O(i),e),r(z(i),e))})(e)}function x(e,t){var a=Array.isArray(e)?new Map(e):e,i=new Map;if(a instanceof Map){var o={};return r(a,(function(e,r){n(_(r),'Map key should be a unit'),t&&t(r,e),r.sid?(n(!(r.sid in o),'duplicate sid found'),o[r.sid]=e):i.set(r,e)})),{sidMap:o,unitMap:i}}return{sidMap:a,unitMap:i}}function w(e){var r=function(){return e()};return r.unsubscribe=function(){return e()},r}Object.defineProperty(exports,'__esModule',{value:1});for(var k,S='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',M='map',j='stack',A=function(e){return e.graphite||e},O=function(e){return e.family.owners},z=function(e){return e.family.links},C=function(e){return e.stateRef},I=function(e){return e.value},N=function(e){return e.subscribers},q=function(e){return e.parent},F=function(e){return e.scope},R=function(e,r){return A(e).meta[r]},D=function(e,r,n){return A(e).meta[r]=n},E=function(e){return e.compositeName},_=function(e){return(ue(e)||oe(e))&&'kind'in e},P=function(e){return function(r){return _(r)&&r.kind===e}},L=P("store"),B=P("event"),T=P("effect"),W=P("domain"),G=P("scope"),H={__proto__:null,unit:_,store:L,event:B,effect:T,domain:W,scope:G,attached:function(e){return T(e)&&1==R(e,'attached')}},U=function(e,r){return e.includes(r)},V=function(e,r){var n=e.indexOf(r);-1!==n&&e.splice(n,1)},$=function(e,r){return e.push(r)},J=function(e,r,n){return!e&&console.error(r+" is deprecated"+(n?", use "+n+" instead":''))},K=function(){var e=0;return function(){return""+ ++e}},Q=K(),X=K(),Y=K(),Z=K(),ee=null,re=function(e){k&&k(e,ee)},ne=function(){return ee&&ee.template},te=function(e){return e&&ee&&ee.sidRoot&&(e=ee.sidRoot+"|"+e),e},ae=function(e,n){var t=A(e);r(n,(function(e){var r=A(e);"domain"!==t.family.type&&(r.family.type="crosslink"),$(O(r),t),$(z(t),r)}))},ie=function(e){return void 0===e&&(e=[]),(Array.isArray(e)?e:[e]).flat().map(A)},oe=function(e){return'object'==typeof e&&null!==e},ue=function(e){return'function'==typeof e},fe=function(e){return void 0===e},se=function(e){return n(oe(e)||ue(e),'expect first argument be an object')},ce=function(e,r,t,a){return n(!(!oe(e)&&!ue(e)||!('family'in e)&&!('graphite'in e)),r+": expect "+t+" to be a unit (store, event or effect)"+a)},de=function(e,n,t){Array.isArray(e)?r(e,(function(e,r){return ce(e,n,r+" item of "+t,'')})):ce(e,n,t,' or array of units')},le=function(e,n,t){return void 0===t&&(t='target'),r(ie(n),(function(r){return J(!R(r,'derived'),e+": derived unit in \""+t+"\"","createEvent/createStore")}))},pe=function(e,r,n){return(0,r.fn)(e,n.a)},ve=function(e,r,n){return(0,r.fn)(n.a,e)},me=function(e,r){return(0,r.fn)(e)},ge=function(e,r,n,t){var a={id:X(),type:e,data:r};return n&&(a.order={priority:n},t&&(a.order.barrierID=++he)),a},he=0,ye=function(e){var r=e.from,n=e.target,t=e.to;return ge('mov',{from:void 0===r?"store":r,store:e.store,to:void 0===t?n?"store":j:t,target:n},e.priority,e.batch)},be=function(e){var r=e.safe,n=e.filter,t=e.pure;return ge('compute',{fn:e.fn,safe:void 0===r?0:r,filter:void 0===n?0:n,pure:void 0===t?0:t},e.priority,e.batch)},xe=function(e){return be({fn:e.fn,priority:"effect"})},we=function(e,r,n){return be({fn:e,safe:1,filter:r,priority:n&&"effect"})},ke=function(e,r,n){return ye({store:e,to:r?j:"a",priority:n&&"sampler",batch:1})},Se=function(e,r){return void 0===e&&(e=me),be({fn:e,pure:1,filter:r})},Me={mov:ye,compute:be,filter:function(e){return be({fn:e.fn,filter:1,pure:e.pure})},run:xe},je=function(e){return{id:X(),current:e}},Ae=function(e){return e.current},Oe=function(e,r){e.before||(e.before=[]),$(e.before,r)},ze=null,Ce=function e(r,n){return r?n?((r.v.type===n.v.type&&r.v.id>n.v.id||_e(r.v.type)>_e(n.v.type))&&(t=r,r=n,n=t),t=e(r.r,n),r.r=r.l,r.l=t,r):r:n;var t},Ie=[],Ne=0;Ne<6;)$(Ie,{first:null,last:null,size:0}),Ne+=1;var qe,Fe,Re=function(){for(var e=0;e<6;e++){var r=Ie[e];if(r.size>0){if(3===e||4===e){r.size-=1;var n=ze.v;return ze=Ce(ze.l,ze.r),n}1===r.size&&(r.last=null);var t=r.first;return r.first=t.r,r.size-=1,t.v}}},De=function(e,r,n,t,a,i,o){return Ee(0,{a:null,b:null,node:n,parent:t,value:a,page:r,scope:i,meta:o},e)},Ee=function(e,r,n,t){void 0===t&&(t=0);var a=_e(n),i=Ie[a],o={v:{idx:e,stack:r,type:n,id:t},l:null,r:null};3===a||4===a?ze=Ce(ze,o):(0===i.size?i.first=o:i.last.r=o,i.last=o),i.size+=1},_e=function(e){switch(e){case'child':return 0;case'pure':return 1;case'read':return 2;case"barrier":return 3;case"sampler":return 4;case"effect":return 5;default:return-1}},Pe=new Set,Le=1,Be=0,Te=0,We=null,Ge=function(e){qe=e},He=function(e){We=e},Ue=function(e,r){if(e){for(;e&&!e.reg[r];)e=q(e);if(e)return e}return null},Ve=function(e,r,n,t,a){var i=Ue(e,t.id);return i?i.reg[t.id]:r?(Je(r,t,a),r.reg[t.id]):t},$e=function(e){return e},Je=function e(n,t,a,i,o){var u,f=n.reg,s=t.sid,c=null==t||null===(u=t.meta)||void 0===u?void 0:u.serialize;if(!f[t.id]){var d={id:t.id,current:t.current,meta:t.meta};if(s&&s in n.values.sidMap&&!(s in n.sidIdMap))d.current=(n.fromSerialize&&'ignore'!==c&&(null==c?void 0:c.read)||$e)(n.values.sidMap[s]);else if(d.id in n.values.idMap)d.current=n.values.idMap[d.id];else if(t.before&&!o){var l=0,p=a||!t.noInit||i;r(t.before,(function(r){switch(r.type){case M:var t=r.from;if(t||r.fn){t&&e(n,t,a,i);var o=t&&f[t.id].current;p&&(d.current=r.fn?r.fn(o):o)}break;case'field':l||(l=1,d.current=Array.isArray(d.current)?[].concat(d.current):Object.assign({},d.current)),e(n,r.from,a,i),p&&(d.current[r.field]=f[f[r.from.id].id].current)}}))}s&&(n.sidIdMap[s]=t.id),f[t.id]=d}},Ke=function(e,r,n){try{return r(I(n),e.scope,n)}catch(t){console.error(t),e.fail=1,e.failReason=t}},Qe=function r(n,t){return void 0===t&&(t={}),oe(n)&&(r(n.or,t),e(n,(function(e,r){fe(e)||'or'===r||'and'===r||(t[r]=e)})),r(n.and,t)),t},Xe=function(e,r){V(e.next,r),V(O(e),r),V(z(e),r)},Ye=function e(r,n,t){var a;r.next.length=0,r.seq.length=0,r.scope=null;for(var i=z(r);a=i.pop();)Xe(a,r),(n||t&&'sample'!==R(r,'op')||"crosslink"===a.family.type)&&e(a,n,'on'!==R(a,'op')&&t);for(i=O(r);a=i.pop();)Xe(a,r),t&&"crosslink"===a.family.type&&e(a,n,'on'!==R(a,'op')&&t)},Ze=function(e){return e.clear()},er=function(e,r){var n=(void 0===r?{}:r).deep,t=0;if(e.ownerSet&&e.ownerSet.delete(e),L(e))Ze(N(e));else if(W(e)){t=1;var a=e.history;Ze(a.events),Ze(a.effects),Ze(a.stores),Ze(a.domains)}Ye(A(e),!!n,t)},rr=function(e){var r=function(){return er(e)};return r.unsubscribe=r,r},nr=function(e,r,n,t,i){return a({node:n,parent:e,child:r,scope:{fn:i},meta:{op:t},family:{owners:[e,r],links:r},regional:1})},tr=function(e,r){return n(ue(r),'.watch argument should be a function'),rr(a({scope:{fn:r},node:[xe({fn:me})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1}))},ar=function(e,r,n){void 0===n&&(n="event"),q(e)&&q(e).hooks[n](r)},ir=function(e,r,n){var t=Qe(n),a="domain"===e,i=Q(),o=t.sid,f=void 0===o?null:o,s=t.named,c=void 0===s?null:s,d=t.domain,l=t.parent,p=void 0===l?void 0===d?null:d:l,v=c||t.name||(a?'':i),m=u(v,p),g={op:r.kind=e,name:r.shortName=v,sid:r.sid=te(f),named:c,unitId:r.id=i,serialize:t.serialize,derived:t.derived,config:t};if(r.parent=p,r.compositeName=m,r.defaultConfig=t,r.thru=function(e){return J(0,'thru','js pipe'),e(r)},r.getType=function(){return m.fullName},!a){r.subscribe=function(e){return se(e),r.watch(ue(e)?e:function(r){return e.next&&e.next(r)})},r[S]=function(){return r};var h=ne();h&&(g.nativeTemplate=h)}return g},or=function(e,r,n,t){var a;oe(n)&&(a=n,n=n.fn);var i=d({name:e.shortName+" \u2192 *",derived:1,and:a});return nr(e,i,t,r,n),i},ur=function(e,r,n,t,a){var i=C(r),o=ye({store:i,to:"a",priority:'read'});n===M&&(o.data.softRead=1);var u=[o,Se(t)];return s('storeOnMap',i,u,L(e)&&C(e)),nr(e,r,u,n,a)},fr=function(r,t,a,i,u){var f=r?function(e){return[].concat(e)}:function(e){return Object.assign({},e)},c=r?[]:{},d=f(c),l=je(d),v=je(1);l.type=r?'list':'shape',l.noInit=1,s('combineBase',l,v);var m=p(d,{name:o(a),derived:1,and:i}),g=C(m);g.noInit=1,D(m,'isCombine',1);var h=ke(l);h.order={priority:'barrier'};var y=[we((function(e,r,n){return n.scope&&!n.scope.reg[l.id]&&(n.c=1),e})),h,ye({store:v,to:'b'}),we((function(e,r,n){var a=r.key;if(n.c||e!==n.a[a])return t&&n.b&&(n.a=f(n.a)),n.a[a]=e,1}),1),ye({from:"a",target:l}),ye({from:"value",store:0,target:v}),ye({from:"value",store:1,target:v,priority:"barrier",batch:1}),ke(l,1),u&&Se()];return e(a,(function(e,r){if(!L(e))return n(!_(e)&&!fe(e),"combine expects a store in a field "+r),void(d[r]=c[r]=e);c[r]=e.defaultState,d[r]=e.getState();var t=nr(e,m,y,'combine',u);t.scope.key=r;var a=C(e);Oe(l,{type:'field',field:r,from:a}),s('combineField',a,t)})),m.defaultShape=a,Oe(g,{type:M,from:l,fn:u}),ne()||(m.defaultState=u?g.current=u(d):c),m},sr=function(e,r,n){try{return[1,e.apply(void 0,n)]}catch(t){return r(t),[0,null]}},cr=function(e){var r=F(e),n={ref:r};return r&&$(r.activeEffects,n),n},dr=function(e,r,n,t,a,o){return function(u){o.ref&&V(o.ref.activeEffects,o),i({target:[t,lr],params:[n?{status:'done',params:e,result:u}:{status:'fail',params:e,error:u},{value:u,fn:n?r.rs:r.rj}],defer:1,page:a.page,scope:o.ref,meta:a.meta})}},lr=a({node:[xe({fn:function(e){return(0,e.fn)(e.value)}})],meta:{op:'fx',fx:'sidechain'}}),pr=['source','clock','target'],vr=function(e,r){return e+": "+r+" should be defined"},mr=function(e,r,t,a,i,o,u,f,c,l,m,g){var y=!!i;n(!fe(t)||!fe(r),vr(e,'either source or clock'));var b=0;fe(t)?b=1:_(t)||(t=v(t)),fe(r)?r=t:(de(r,e,'clock'),Array.isArray(r)&&(r=h(r))),b&&(t=r),f||u||(u=t.shortName);var x='none';(m||a)&&(_(a)?x='unit':(n(ue(a),'`filter` should be function or unit'),x='fn')),i?(de(i,e,'target'),le(e,i)):'none'===x&&l&&L(t)&&L(r)?i=p(o?o(Ae(C(t)),Ae(C(r))):Ae(C(t)),{name:u,sid:g,or:f}):(i=d({name:u,derived:1,or:f}),s('sampleTarget',A(i)));var w=je(),k=[];if('unit'===x){var S=hr(a,i,r,w,e),M=S[0];k=[].concat(gr(S[1]),gr(M))}var O=hr(t,i,r,w,e),z=O[0],I=O[1],N=nr(r,i,[s('sampleSourceLoader'),ye({from:j,target:w})].concat(gr(I),[ke(z,1,c)],k,[ke(w),'fn'===x&&Se((function(e,r,n){return a(e,n.a)}),1),o&&Se(pe),s('sampleSourceUpward',y)]),e,o);return ae(t,[N]),Object.assign(N.meta,f,{joint:1}),i},gr=function(e){return[ke(e),we((function(e,r,n){return n.a}),1)]},hr=function(e,r,n,t,i){var o=L(e),u=o?C(e):je(),f=je(o);return o||a({parent:e,node:[ye({from:j,target:u}),ye({from:"value",store:1,target:f})],family:{owners:[e,r,n],links:r},meta:{op:i},regional:1}),s('sampleSource',f,u,t),[u,f]},yr=function(e,r,n,t){var a=e[r];a&&i({target:a,params:Array.isArray(a)?a.map((function(){return n})):n,defer:1,stack:t})},br=function(e){return e};exports.allSettled=function(e,r){var n=void 0===r?{}:r,t=n.scope,a=n.params;if(!_(e))return Promise.reject(new Error('first argument should be unit'));if(!(T(e)||B(e)||L(e)||G(e)))return Promise.reject(new Error('first argument accepts only effects, events, stores or scopes'));G(e)&&(t=e);var o=m();o.parentFork=qe;var u=t.fxCount;$(u.scope.defers,o);var f=[],s=[];return G(e)||($(f,e),$(s,T(e)?{params:a,req:{rs:function(e){o.value={status:'done',value:e}},rj:function(e){o.value={status:'fail',value:e}}}}:a)),$(f,u),$(s,null),i({target:f,params:s,scope:t}),o.req},exports.attach=function(e){var r,n=f(e,1),t=(e=n[0]).source,a=e.effect,o=e.mapParams,s=g(e,n[1]);D(s,'attached',1);var c,d,l=A(s).scope.runner,p=we((function(e,r,n){var a,u=e.params,f=e.req,c=e.handler,d=s.finally,l=cr(n),p=dr(u,f,0,d,n,l),v=n.a,m=T(c),g=1;if(o){var h=sr(o,p,[u,v]);g=h[0],a=h[1]}else a=t&&m?v:u;if(g){if(!m)return e.args=[v,a],1;i({target:c,params:{params:a,req:{rs:dr(u,f,1,d,n,l),rj:p}},page:n.page,defer:1,meta:n.meta})}}),1,1);t?(L(t)?ae(d=t,[s]):(d=v(t),ae(s,[d])),c=[ke(C(d)),p]):c=[p],(r=l.seq).splice.apply(r,[1,0].concat(c)),s.use(a);var m=q(a);return m&&(Object.assign(E(s),u(s.shortName,m)),s.defaultConfig.parent=m),ar(a,s,"effect"),s},exports.clearNode=er,exports.combine=v,exports.createApi=function(){for(var r=arguments.length,n=new Array(r),t=0;t<r;t++)n[t]=arguments[t];var a=f(n),i=a[0],o=i[0],u=i[1],s=a[1],c={};return e(u,(function(e,r){var n=c[r]=d(r,{parent:q(o),config:s});o.on(n,e),ar(o,n)})),c},exports.createDomain=function n(t,o){var u=Qe({or:o,and:'string'==typeof t?{name:t}:t}),f=a({family:{type:"domain"},regional:1,parent:(null==u?void 0:u.domain)||(null==u?void 0:u.parent)}),s={history:{},graphite:f,hooks:{}};f.meta=ir("domain",s,{parent:(null==u?void 0:u.domain)||(null==u?void 0:u.parent),or:u}),e({Event:d,Effect:g,Store:p,Domain:n},(function(e,n){var t=n.toLowerCase(),a=d({named:"on"+n});s.hooks[t]=a;var o=new Set;s.history[t+"s"]=o,a.create=function(e){return i(a,e),e},$(A(a).seq,we((function(e,r,n){return n.scope=null,e}))),a.watch((function(e){ae(s,[e]),o.add(e),e.ownerSet||(e.ownerSet=o),q(e)||(e.parent=s)})),ae(s,[a]),s["onCreate"+n]=function(e){return r(o,e),a.watch(e)},s["create"+n]=s[t]=function(r,n){var t=Qe({and:n,or:r});return null!=t&&t.domain?e(r,n):a(e(r,{parent:s,or:t}))}}));var c=q(s);return c&&e(s.hooks,(function(e,r){return nr(e,c.hooks[r])})),null!=u&&u.domain&&u.domain.hooks.domain(s),s},exports.createEffect=g,exports.createEvent=d,exports.createNode=a,exports.createStore=p,exports.createStoreObject=function(){return J(0,'createStoreObject','combine'),v.apply(void 0,arguments)},exports.createWatch=function(e){var r=e.unit,n=e.fn,t=e.scope,i=[Me.run({fn:function(e){return n(e)}})];if(t){var o=a({node:i}),u=r.graphite.id,f=t.additionalLinks,s=f[u]||[];return f[u]=s,s.push(o),w((function(){var e=s.indexOf(o);-1!==e&&s.splice(e,1),er(o)}))}var c=a({node:i,parent:[r],family:{owners:r}});return w((function(){er(c)}))},exports.fork=function(e,t){var i,o=e;W(e)&&(i=e,o=t);var u=function(e){var n=a({scope:{defers:[],inFlight:0,fxID:0},node:[we((function(e,r,n){q(n)?'dec'===R(q(n).node,'needFxCounter')?r.inFlight-=1:(r.inFlight+=1,r.fxID+=1):r.fxID+=1})),be({priority:"sampler",batch:1}),we((function(e,n){var t=n.defers,a=n.fxID;n.inFlight>0||0===t.length||Promise.resolve().then((function(){n.fxID===a&&r(t.splice(0,t.length),(function(e){Ge(e.parentFork),e.rs(e.value)}))}))}),0,1)]}),t=a({node:[we((function(e,r,n){var t=q(n);if(t){var a=t.node;if(!R(a,'isCombine')||q(t)&&'combine'!==R(q(t).node,'op')){var i=F(n),o=a.scope.state.id,u=R(a,'sid');i.sidIdMap[u]=o,i.values.sidMap[u]=e;var f=R(a,'serialize');f&&i.sidSerializeSettings.set(u,'ignore'===f?{ignore:1}:{ignore:0,write:f.write})}}}))]}),i=a({node:[we((function(e,r,n){var t=F(n);if(t){var a=q(n);a&&(!R(a.node,'isCombine')||q(a)&&'combine'!==R(q(a).node,'op'))&&(t.warnSerialize=1)}}))]}),o={cloneOf:e,reg:{},values:{sidMap:{},idMap:{}},sidIdMap:{},sidSerializeSettings:new Map,getState:function(e){if('current'in e)return Ve(We,o,null,e).current;var r=A(e);return Ve(We,o,r,r.scope.state,1).current},kind:"scope",graphite:a({family:{type:"domain",links:[n,t,i]},meta:{unit:'fork'},scope:{forkInFlightCounter:n}}),additionalLinks:{},handlers:{sidMap:{},unitMap:new Map},fxCount:n,storeChange:t,warnSerializeNode:i,activeEffects:[]};return o}(i);if(o){var f=o.scope;if(f){var s=f.activeEffects;f.activeEffects=[],u.activeEffects=s,r(s,(function(e){return e.ref=u}))}if(o.values){var c=x(o.values,(function(e){return n(L(e),'Values map can contain only stores as keys')})),d=c.unitMap;Object.assign(u.values.sidMap,c.sidMap),r(d,(function(e,r){u.values.idMap[r.stateRef.id]=e})),u.fromSerialize=!(Array.isArray(o.values)||o.values instanceof Map)}o.handlers&&(u.handlers=x(o.handlers,(function(e){return n(T(e),"Handlers map can contain only effects as keys")})))}return u},exports.forward=function(e){var r='forward',n=f(e,1),t=n[0],i=t.from,o=t.to,u=n[1];return de(i,r,'"from"'),de(o,r,'"to"'),le(r,o,'to'),rr(a({parent:i,child:o,meta:{op:r,config:u},family:{},regional:1}))},exports.fromObservable=function(e){se(e);var r=S in e?e[S]():e;n(r.subscribe,'expect observable to have .subscribe');var t=d(),a=rr(t);return r.subscribe({next:t,error:a,complete:a}),t},exports.guard=function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];var t=f(r),a=t[0],i=a[0],o=a[1],u=t[1];return o||(i=(o=i).source),y(o,'guard'),mr('guard',o.clock,i,o.filter,o.target,null,o.name,u,!o.greedy,0,1)},exports.hydrate=function(e,t){var a=t.values;n(oe(a),'values property should be an object');var o=x(a),u=o.sidMap,f=o.unitMap,s=Object.getOwnPropertyNames(u),c={};r(f,(function(e,r){c[r.stateRef.id]=r}));var d,l,p,v=[],m=[];G(e)?(p=1,n((d=e).cloneOf,'scope should be created from domain'),l=A(d.cloneOf)):W(e)?l=A(e):n(0,'first argument of hydrate should be domain or scope'),b(l,(function(e,r){if(r&&U(s,r)){$(v,e);var n=R(e,'serialize');n&&'ignore'!==n&&(u[r]=n.read(u[r])),$(m,u[r])}else e.scope.state.id in c&&($(v,e),$(m,f.get(c[e.scope.state.id])))}),1),i({target:v,params:m,scope:d}),p&&Object.assign(d.values.sidMap,u)},exports.is=H,exports.launch=i,exports.merge=h,exports.restore=function(r,n,t){if(L(r))return J(0,'restore($store)'),r;if(B(r)||T(r)){var a=q(r),i=p(n,{parent:a,name:r.shortName,and:t});return nr(T(r)?r.doneData:r,i),a&&a.hooks.store(i),i}var o=Array.isArray(r)?[]:{};return e(r,(function(e,r){return o[r]=L(e)?e:p(e,{name:r})})),o},exports.sample=function(){for(var e,r,n=arguments.length,t=new Array(n),a=0;a<n;a++)t[a]=arguments[a];var i,o,u=f(t),s=u[0],c=s[0],d=s[1],l=s[2],p=u[1],v=1;return fe(d)&&oe(c)&&y(c,"sample")&&(d=c.clock,l=c.fn,v=!c.greedy,o=c.filter,e=c.target,r=c.name,i=c.sid,c=c.source),mr("sample",d,c,o,e,l,r,p,v,1,0,i)},exports.scopeBind=function(e,r){var t=void 0===r?{}:r,a=t.scope;n(a||qe||t.safe,'scopeBind cannot be called outside of forked .watch');var o=a||qe;return T(e)?function(r){var n=m();return i({target:e,params:{params:r,req:n},scope:o}),n.req}:function(r){return i({target:e,params:r,scope:o}),r}},exports.serialize=function(r,t){void 0===t&&(t={}),r.warnSerialize&&console.error('There is a store without sid in this scope, its value is omitted');var a=t.ignore?t.ignore.map((function(e){return e.sid})):[],i={};return e(r.values.sidMap,(function(e,n){var t;if(!U(a,n)){var o=r.sidIdMap[n],u=null!==(t=r.sidSerializeSettings.get(n))&&void 0!==t?t:{ignore:0,write:br};u.ignore||(i[n]=(0,u.write)(o&&o in r.reg?r.reg[o].current:e))}})),'onlyChanges'in t&&!t.onlyChanges&&(n(r.cloneOf,'scope should be created from domain'),b(A(r.cloneOf),(function(e,n){n in i||U(a,n)||R(e,'isCombine')||'ignore'===R(e,'serialize')||(i[n]=r.getState(e))}))),i},exports.setGraphInspector=function(e){k=e},exports.setInspector=function(e){Fe=e},exports.setStoreName=function(e,r){e.shortName=r,Object.assign(E(e),u(r,q(e)))},exports.split=function(){for(var r,t,i='split',o=arguments.length,u=new Array(o),c=0;c<o;c++)u[c]=arguments[c];var l=f(u),p=l[0],v=p[0],m=p[1],g=l[1],h=!m;h&&(r=v.cases,m=v.match,t=v.clock,v=v.source);var y=L(m),b=!_(m)&&ue(m),x=!y&&!b&&oe(m);n(_(v),'source must be a unit'),r||(r={}),h?e(r,(function(e,r){return le(i,e,"cases."+r)})):(n(x,'match should be an object'),e(m,(function(e,n){return r[n]=d({derived:1,named:"cases."+n,and:g})})),r.__=d({derived:1,named:'cases.__',and:g}));var w,k=new Set([].concat(v,t||[],Object.values(r))),S=Object.keys(y||b?r:m);if(y||b)y&&k.add(m),w=[y&&ke(C(m),0,1),be({safe:y,filter:1,pure:!y,fn:function(e,r,n){var t=String(y?n.a:m(e));yr(r,U(S,t)?t:'__',e,n)}})];else if(x){var M=je({});M.type='shape';var j,A=[];e(m,(function(e,r){if(_(e)){j=1,$(A,r),k.add(e);var n=nr(e,[],[ke(M),we((function(e,n,t){return t.a[r]=e}))]);if(L(e)){M.current[r]=e.getState();var t=C(e);Oe(M,{from:t,field:r,type:'field'}),s('splitMatchStore',t,n)}}})),j&&s('splitBase',M),w=[j&&ke(M,0,1),Se((function(e,r,n){for(var t=0;t<S.length;t++){var a=S[t];if(U(A,a)?n.a[a]:m[a](e))return void yr(r,a,e,n)}yr(r,'__',e,n)}),1)]}else n(0,'expect match to be unit, function or object');var O=a({meta:{op:i},parent:t?[]:v,scope:r,node:w,family:{owners:Array.from(k)},regional:1});if(t&&mr(i,t,v,null,O,null,i,g,0,0,0),!h)return r},exports.step=Me,exports.version="22.8.3",exports.withFactory=function(e){var r=e.sid,n=e.name,i=e.loc,o=e.method,u=e.fn;return t(a({meta:{sidRoot:te(r),sid:r,name:n,loc:i,method:o,type:'factory'}}),u)},exports.withRegion=t;
//# sourceMappingURL=compat.js.map
